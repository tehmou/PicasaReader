<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

    <style type="text/css">

        body {
            margin: 0;
            padding: 0;
            background: #eee;
        }
        
        #webgl-canvas {
            position: absolute;
            width: 900px;
            height: 600px;
            left: 50%;
            top: 50%;
            margin-left: -450px;
            margin-top: -300px;
            border: 1px solid black;
        }
        
    </style>

    <script type="text/javascript" src="lib/underscore.js"></script>
    <script type="text/javascript" src="lib/jquery-1.6.1.js"></script>
    <script type="text/javascript" src="lib/RequestAnimationFrame.js"></script>
    <script type="text/javascript" src="lib/glMatrix-0.9.5.min.js"></script>
    <script type="text/javascript" src="js/namespace.js"></script>
    <script type="text/javascript" src="js/gl/glShaderUtils.js"></script>
    <script type="text/javascript" src="js/gl/glTextureUtils.js"></script>

    <script type="text/javascript">

    $(function () {

        ({
            el: $("#webgl-canvas"),
            imageUrl: "cache/full/IMG_2273.JPG",
            fragmentShaderName: "fs-thumb",
            vertexShaderName: "vs-default",
            shader: null,

            init: function () {
                this.renderLoop = _.bind(this.renderLoop, this);
                $(window).resize(_.bind(this.updateDimensions, this));
                this.updateDimensions();
                this.createGL();
                this.loadShader();
                this.createPlane();
                this.createTexture();
                this.renderLoop();
            },
            updateDimensions: function () {
                this.el[0].width = this.el.width();
                this.el[0].height = this.el.height();
                this.viewportWidth = this.el[0].width;
                this.viewportHeight = this.el[0].height;
                this.halfW = this.viewportWidth/2.0;
                this.halfH = this.viewportHeight/2.0;
            },
            createGL: function () {
                this.gl = this.el[0].getContext("experimental-webgl");
                this.gl.enable(this.gl.TEXTURE_2D);
                this.gl.clearColor(0.0, 0.0, 0.0, 0.0);
            },
            loadShader: function () {
                var that = this;
                $.ajax("js/gl/shaders/" + that.fragmentShaderName + ".txt", {
                    dataType: "text",
                    success: function (fsCode) {
                        $.ajax("js/gl/shaders/" + that.vertexShaderName + ".txt", {
                            dataType: "text",
                            success: function (vsCode) {
                                that.createShader(fsCode, vsCode);
                            }
                        })
                    }
                });
            },
            createShader: function (fsCode, vsCode) {
                this.shader = timotuominen.gl.glShaderUtils.createShader(this.gl, fsCode, vsCode);
                this.gl.useProgram(this.shader);
                this.gl.enableVertexAttribArray(this.gl.getAttribLocation(this.shader, "position"));
                this.resetShaderMatrices();
            },
            resetShaderMatrices: function () {
                var m = mat4.create();
                mat4.identity(m);
                this.setShaderMVMatrix(m);
                this.setShaderPMatrix(m);
            },
            setShaderMVMatrix: function (matrix) {
                this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.shader, "uMVMatrix"), false, matrix);
            },
            setShaderPMatrix: function (matrix) {
                this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.shader, "uPMatrix"), false, matrix);
            },
            createPlane: function () {
                var vertices = new Float32Array([ -1.0,-1.0, 1.0,-1.0, -1.0,1.0, 1.0,-1.0, 1.0,1.0, -1.0,1.0]);
                this.mQuadVBO = this.gl.createBuffer();
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.mQuadVBO);
                this.gl.bufferData(this.gl.ARRAY_BUFFER, vertices, this.gl.STATIC_DRAW);
            },
            createTexture: function () {
                this.texture = timotuominen.gl.glTextureUtils.loadImageTexture(this.gl, this.imageUrl);
            },
            renderLoop: function () {
                requestAnimationFrame(this.renderLoop);
                this.preRender();
                this.actualRender();
            },
            preRender: function () {
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.mQuadVBO);
                this.gl.vertexAttribPointer(this.gl.getAttribLocation(this.shader, "position"), 2, this.gl.FLOAT, false, 0, 0);
            },
            actualRender: function () {
                var w = this.viewportWidth;
                var h = this.viewportHeight;
                this.gl.viewport(0, 0, w, h);
                this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);
                if (this.shader) {
                    this.gl.useProgram(this.shader);
                    this.gl.enableVertexAttribArray(this.gl.getAttribLocation(this.shader, "position"));
                }
                this.gl.uniform2f(this.gl.getUniformLocation(this.shader, "resolution"), w, h);
                this.gl.uniform1f(this.gl.getUniformLocation(this.shader, "ratio"), 0.5);
                this.gl.activeTexture(this.gl.TEXTURE0);
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture);
                this.gl.uniform1i(this.gl.getUniformLocation(this.shader, "tex0"), 0);
                this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
            }
        }).init();
    });

    </script>

    <body>
        <canvas id="webgl-canvas"></canvas>
    </body>
</html>